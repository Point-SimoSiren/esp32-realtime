<!doctype html>
<html lang="fi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#0b1220" />
    <title>ESP32 LED</title>
    <style>
      :root {
        --bg: #0b1220;
        --card: rgba(255, 255, 255, 0.06);
        --text: rgba(255, 255, 255, 0.92);
        --muted: rgba(255, 255, 255, 0.66);
        --ok: #22c55e;
        --off: #94a3b8;
        --danger: #ef4444;
        --shadow: 0 20px 50px rgba(0, 0, 0, 0.45);
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        min-height: 100vh;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto,
          Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        color: var(--text);
        background: radial-gradient(
            1200px 700px at 30% -10%,
            rgba(59, 130, 246, 0.35),
            transparent 60%
          ),
          radial-gradient(
            1000px 600px at 110% 30%,
            rgba(34, 197, 94, 0.22),
            transparent 55%
          ),
          var(--bg);
        display: grid;
        place-items: center;
        padding: 18px;
      }
      .wrap {
        width: min(520px, 100%);
      }
      .card {
        background: var(--card);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 18px;
        padding: 18px;
        box-shadow: var(--shadow);
        backdrop-filter: blur(10px);
      }
      header {
        display: flex;
        gap: 12px;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 14px;
      }
      h1 {
        font-size: 18px;
        margin: 0;
        letter-spacing: 0.2px;
      }
      .pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-size: 12px;
        padding: 8px 10px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: var(--muted);
      }
      .dot {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        background: var(--off);
        box-shadow: 0 0 0 0 rgba(34, 197, 94, 0);
      }
      .dot.on {
        background: var(--ok);
        box-shadow: 0 0 0 6px rgba(34, 197, 94, 0.15);
      }
      .dot.err {
        background: var(--danger);
        box-shadow: 0 0 0 6px rgba(239, 68, 68, 0.15);
      }
      .big {
        margin: 16px 0 10px;
        display: grid;
        gap: 12px;
      }
      button {
        -webkit-tap-highlight-color: transparent;
        appearance: none;
        border: 0;
        width: 100%;
        border-radius: 16px;
        padding: 18px 16px;
        font-size: 18px;
        font-weight: 650;
        color: white;
        background: linear-gradient(135deg, #2563eb, #60a5fa);
        box-shadow: 0 10px 24px rgba(59, 130, 246, 0.35);
        cursor: pointer;
        transition: transform 80ms ease, filter 160ms ease;
      }
      button:active {
        transform: translateY(1px) scale(0.99);
        filter: brightness(0.96);
      }
      button.off {
        background: linear-gradient(135deg, #334155, #64748b);
        box-shadow: 0 10px 24px rgba(148, 163, 184, 0.2);
      }
      .row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      .ghost {
        background: rgba(255, 255, 255, 0.08);
        box-shadow: none;
        border: 1px solid rgba(255, 255, 255, 0.12);
        color: rgba(255, 255, 255, 0.9);
      }
      .status {
        font-size: 13px;
        color: var(--muted);
        display: flex;
        justify-content: space-between;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 10px;
      }
      code {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        font-size: 12px;
        color: rgba(255, 255, 255, 0.9);
      }
      .hint {
        margin-top: 12px;
        font-size: 12px;
        color: rgba(255, 255, 255, 0.55);
        line-height: 1.35;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="card">
        <header>
          <h1>ESP32 LED -ohjaus</h1>
          <div class="pill">
            <span id="dot" class="dot"></span>
            <span id="pillText">Yhdistetaan...</span>
          </div>
        </header>

        <div class="big">
          <button id="toggleBtn" type="button">...</button>
          <div class="row">
            <button id="onBtn" class="ghost" type="button">Paalle</button>
            <button id="offBtn" class="ghost" type="button">Pois</button>
          </div>
        </div>

        <div class="status">
          <div>LED: <code id="ledState">?</code></div>
          <div>Vesivuoto: <code id="waterState">?</code></div>
          <div>Anturi: <code id="waterValue">?</code></div>
          <div>Viimeisin: <code id="lastMsg">-</code></div>
        </div>

        <div class="hint">
          Paivitys tulee SSE:lla ilman pollausta. Jos nakyma ei loydy, aja
          <code>pio run -t uploadfs</code> ennen ohjelman uploadia.
        </div>
      </div>
    </div>

    <script>
      const $ = (id) => document.getElementById(id);
      const dot = $("dot");
      const pillText = $("pillText");
      const toggleBtn = $("toggleBtn");
      const onBtn = $("onBtn");
      const offBtn = $("offBtn");
      const ledState = $("ledState");
      const waterState = $("waterState");
      const waterValue = $("waterValue");
      const lastMsg = $("lastMsg");

      let currentLed = null;
      let currentWaterLeak = null;
      let currentWaterValue = null;
      let currentThreshold = null;
      let connected = false;

      function stamp(msg) {
        lastMsg.textContent = `${new Date().toLocaleTimeString()} ${msg}`;
      }

      function render() {
        ledState.textContent =
          currentLed === true ? "ON" : currentLed === false ? "OFF" : "?";
        waterState.textContent =
          currentWaterLeak === true
            ? "HAVAITTU"
            : currentWaterLeak === false
              ? "EI"
              : "?";

        waterValue.textContent =
          typeof currentWaterValue === "number"
            ? `${currentWaterValue}${typeof currentThreshold === "number" ? ` (kynnys ${currentThreshold})` : ""}`
            : "?";

        toggleBtn.textContent =
          currentLed === true
            ? "Sammuta LED"
            : currentLed === false
              ? "Sytyta LED"
              : "...";
        toggleBtn.classList.toggle("off", currentLed === true);

        dot.classList.toggle("on", connected && currentLed === true);
        dot.classList.toggle("err", !connected);
        pillText.textContent = !connected
          ? "Ei yhteytta"
          : currentLed === true
            ? "Paalla"
            : "Pois";
      }

      function applyStatus(status) {
        currentLed = !!status?.led;
        currentWaterLeak = !!status?.water?.detected;
        currentWaterValue =
          typeof status?.water?.value === "number" ? status.water.value : null;
        currentThreshold =
          typeof status?.water?.threshold === "number"
            ? status.water.threshold
            : null;
        render();
      }

      async function apiStatus() {
        const res = await fetch("/api/status", { cache: "no-store" });
        if (!res.ok) throw new Error(`status ${res.status}`);
        return await res.json();
      }

      async function apiSet(state) {
        const res = await fetch(`/api/led?state=${encodeURIComponent(state)}`, {
          method: "POST",
          cache: "no-store",
        });
        const body = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(body?.error || `set ${res.status}`);
        return body;
      }

      function connectSse() {
        const es = new EventSource("/api/events");

        es.addEventListener("status", (event) => {
          try {
            const status = JSON.parse(event.data);
            connected = true;
            applyStatus(status);
          } catch (e) {
            stamp(`Virheellinen SSE-data: ${e?.message || e}`);
          }
        });

        es.onopen = () => {
          connected = true;
          render();
          stamp("SSE yhdistetty");
        };

        es.onerror = () => {
          connected = false;
          render();
          stamp("SSE yhteys poikki, yritetaan uudelleen");
        };
      }

      async function setLed(next) {
        toggleBtn.disabled = true;
        onBtn.disabled = true;
        offBtn.disabled = true;
        try {
          const s = await apiSet(next ? "on" : "off");
          applyStatus(s);
          stamp(next ? "Paalle" : "Pois");
        } catch (e) {
          stamp(String(e?.message || e));
        } finally {
          toggleBtn.disabled = false;
          onBtn.disabled = false;
          offBtn.disabled = false;
        }
      }

      toggleBtn.addEventListener("click", () => {
        if (currentLed === null) return;
        return setLed(!currentLed);
      });
      onBtn.addEventListener("click", () => setLed(true));
      offBtn.addEventListener("click", () => setLed(false));

      (async () => {
        try {
          const initial = await apiStatus();
          applyStatus(initial);
          connected = true;
          render();
          stamp("Alkutila haettu");
        } catch (e) {
          connected = false;
          render();
          stamp(String(e?.message || e));
        }
        connectSse();
      })();
    </script>
  </body>
</html>
